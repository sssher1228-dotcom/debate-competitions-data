<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è‹±è¾©æ¯”èµ›ç®¡ç†åå°</title>
  <style>
    /* === ä¿ç•™ä½ çš„åŸæ ·å¼ï¼ˆæœªæ”¹åŠ¨ï¼‰ === */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;line-height:1.6;color:#333;background-color:#f8f9fa}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;text-align:center;padding:40px 20px;margin-bottom:30px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    h1{font-size:2.2em;margin-bottom:10px;font-weight:700}
    .subtitle{font-size:1.1em;opacity:.9;font-weight:300}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:.3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:#667eea;color:#fff}.btn-primary:hover{background:#5a6fd8;transform:translateY(-2px)}
    .btn-secondary{background:#6c757d;color:#fff}.btn-secondary:hover{background:#5a6268}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-small{padding:8px 16px;font-size:12px}
    .competitions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:25px;margin-bottom:40px}
    .competition-card{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 20px rgba(0,0,0,.08);transition:.3s;border:1px solid #e9ecef;position:relative}
    .competition-card:hover{transform:translateY(-3px);box-shadow:0 15px 40px rgba(0,0,0,.12)}
    .competition-title{font-size:1.3em;font-weight:600;color:#2c3e50;margin-bottom:15px;border-bottom:3px solid #667eea;padding-bottom:8px}
    .competition-info{margin-bottom:15px}
    .info-row{display:flex;margin-bottom:8px;align-items:flex-start}
    .info-label{font-weight:600;color:#495057;min-width:70px;margin-right:10px;font-size:.9em}
    .info-content{flex:1;color:#6c757d;font-size:.9em;word-break:break-word}
    .website-link{color:#667eea;text-decoration:none;border-bottom:1px solid #667eea}.website-link:hover{color:#5a6fd8}
    .card-actions{display:flex;gap:10px;margin-top:15px;padding-top:15px;border-top:1px solid #e9ecef}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:2% auto;padding:0;border-radius:15px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px 30px;border-radius:15px 15px 0 0;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.4em;font-weight:600}.close{color:#fff;font-size:28px;font-weight:700;cursor:pointer;line-height:1}.close:hover{opacity:.7}
    .modal-body{padding:30px}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#495057}
    .form-control{width:100%;padding:12px 15px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;transition:.3s}
    .form-control:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    textarea.form-control{resize:vertical;min-height:80px}
    .tags-input{display:flex;flex-wrap:wrap;gap:8px;padding:8px;border:2px solid #e9ecef;border-radius:8px;min-height:45px;cursor:text}
    .tags-input:focus-within{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .tag-item{background:#e3f2fd;color:#1976d2;padding:4px 8px;border-radius:15px;font-size:12px;display:flex;align-items:center;gap:5px}
    .tag-remove{cursor:pointer;font-weight:700}
    .tag-input{border:none;outline:none;flex:1;min-width:100px;padding:4px}
    .modal-footer{padding:20px 30px;border-top:1px solid #e9ecef;display:flex;justify-content:flex-end;gap:15px}
    .loading{display:none;text-align:center;padding:40px;color:#6c757d}
    .spinner{border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .alert{padding:15px 20px;margin-bottom:20px;border-radius:8px;font-weight:500}
    .alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    @media (max-width:768px){.container{padding:10px}.competitions-grid{grid-template-columns:1fr}.modal-content{width:95%;margin:5% auto}.toolbar{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>è‹±è¾©æ¯”èµ›ç®¡ç†åå°</h1>
      <p class="subtitle">ç®¡ç†ä¸­å­¦ç”Ÿè‹±è¾©æ¯”èµ›ä¿¡æ¯</p>
    </header>

    <div class="toolbar">
      <button class="btn btn-primary" onclick="openAddModal()">â• æ·»åŠ æ–°æ¯”èµ›</button>
      <div>
        <a href="/" class="btn btn-secondary">ğŸŒ æŸ¥çœ‹ç½‘ç«™</a>
        <button class="btn btn-success" onclick="loadCompetitions()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      </div>
    </div>

    <div id="alert-container"></div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>åŠ è½½ä¸­...</p>
    </div>

    <div class="competitions-grid" id="competitions-grid"></div>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘æ¯”èµ›æ¨¡æ€æ¡† -->
  <div id="competitionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">æ·»åŠ æ–°æ¯”èµ›</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="competition-form">
          <div class="form-group">
            <label class="form-label" for="title">æ¯”èµ›ç®€ç§° *</label>
            <input type="text" class="form-control" id="title" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="fullName">æ¯”èµ›å…¨ç§° *</label>
            <input type="text" class="form-control" id="fullName" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="format">èµ›åˆ¶ *</label>
            <input type="text" class="form-control" id="format" required value="è‹±å›½è®®ä¼šåˆ¶è¾©è®ºï¼ˆBPï¼‰">
          </div>
          <div class="form-group">
            <label class="form-label" for="participants">å‚èµ›å¯¹è±¡ *</label>
            <textarea class="form-control" id="participants" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="time">æ¯”èµ›æ—¶é—´ *</label>
            <textarea class="form-control" id="time" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="requirements">å‚èµ›è¦æ±‚ *</label>
            <textarea class="form-control" id="requirements" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="location">åœ°ç†ä½ç½® *</label>
            <textarea class="form-control" id="location" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="organizer">ä¸»åŠæ–¹ *</label>
            <input type="text" class="form-control" id="organizer" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="website">ç½‘å€ *</label>
            <input type="url" class="form-control" id="website" required placeholder="https://...">
          </div>
          <div class="form-group">
            <label class="form-label">æ ‡ç­¾</label>
            <div class="tags-input" id="tags-input" onclick="focusTagInput()">
              <input type="text" class="tag-input" id="tag-input" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ ">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveCompetition()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== éœ€æ›¿æ¢çš„ä¸¤ä¸ªå˜é‡ ====== */
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1210v7iHdMSMLCApPlbhQ9yueYZWNkG1k2LXZdcRTtV4/export?format=csv&gid=0";
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4hsNS81BYcfENUXgpSlM-sw1E0GMDfEzsvBSOwPV6wdImoddwIbiv_SIKCnZabLXL/exec";
    const SHARED_SECRET = "";

    /* ====== å†…éƒ¨çŠ¶æ€ ====== */
    let competitions = [];
    let currentTags = [];
    let currentEditingKey = null; // ç”¨ short_name ä½œä¸ºå”¯ä¸€é”®

    document.addEventListener('DOMContentLoaded', () => {
      loadCompetitions();
      const tagInput = document.getElementById('tag-input');
      tagInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const v = tagInput.value.trim();
          if (v && !currentTags.includes(v)) {
            currentTags.push(v);
            tagInput.value = '';
            renderTags();
          }
        }
      });
    });

    /* ====== è¯»å–ï¼šä» Sheet CSV æ‹‰å–å¹¶æ˜ å°„åˆ°ä½ çš„å­—æ®µå‘½å ====== */
    function parseCSV(text){
      const rows=[], cur=[], push=()=>{rows.push(cur.slice());cur.length=0};
      let v="", q=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(q){
          if(c==='"' && n==='"'){ v+='"'; i++; }
          else if(c==='"'){ q=false; }
          else { v+=c; }
        }else{
          if(c==='"'){ q=true; }
          else if(c===','){ cur.push(v); v=""; }
          else if(c==='\n'){ cur.push(v); v=""; push(); }
          else { v+=c; }
        }
      }
      if(v!=="" || cur.length){ cur.push(v); push(); }
      return rows;
    }
    function rowToObj(headers,row){
      const cell = h => row[headers.indexOf(h)] || '';
      const tagsRaw = String(cell('tags')||'').replace(/ï¼Œ/g,',').replace(/\|/g,',');
      const tagsArr = tagsRaw.split(',').map(s=>s.trim()).filter(Boolean);
      return {
        id: cell('short_name'),
        title: cell('short_name'),
        fullName: cell('full_name'),
        format: cell('format'),
        participants: cell('audience'),
        time: cell('time'),
        requirements: cell('requirement'),
        location: cell('location'),
        organizer: cell('organizer'),
        website: cell('url'),
        tags: tagsArr
      };
    }

    async function loadCompetitions(){
      showLoading(true);
      try{
        const res = await fetch(SHEET_CSV_URL + '&_t=' + Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const csv = await res.text();
        const rows = parseCSV(csv);
        if(!rows.length) { competitions = []; renderCompetitions(); return; }
        const headers = rows.shift().map(h=>h.trim());
        competitions = rows
          .filter(r => r && r.join('').trim() !== '')
          .map(r => rowToObj(headers, r));
        renderCompetitions();
      }catch(e){
        showAlert('åŠ è½½å¤±è´¥ï¼š' + e.message, 'error');
      }finally{
        showLoading(false);
      }
    }

    /* ====== å†™å…¥ï¼šè°ƒç”¨ Apps Script APIï¼ˆno-cors æ–¹æ¡ˆï¼‰ ====== */
async function callAPI(action, recordOrKey) {
  const payload = (action === 'delete')
    ? { action, key: recordOrKey, secret: SHARED_SECRET }
    : { action, record: recordOrKey, key: recordOrKey.short_name, secret: SHARED_SECRET };

  // å…³é”®ï¼šno-cors + text/plainï¼Œä¸”ä¸è¯»å–å“åº”ã€ä¸æ£€æŸ¥ res.ok
  await fetch(APPS_SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    cache: 'no-store',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  });

  // è¿™é‡Œä¸èƒ½ç”¨ res.okï¼Œå› ä¸º no-cors çš„å“åº”æ˜¯ opaque
  return true;
}

    /* ====== æ¸²æŸ“å¡ç‰‡ ====== */
    function renderCompetitions(){
      const grid = document.getElementById('competitions-grid');
      if(!competitions.length){
        grid.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">æš‚æ— æ¯”èµ›æ•°æ®</div>';
        return;
      }
      grid.innerHTML = competitions.map(c => `
        <div class="competition-card">
          <h3 class="competition-title">${c.title}</h3>
          <div class="competition-info">
            <div class="info-row"><span class="info-label">å…¨ç§°:</span><span class="info-content">${c.fullName||''}</span></div>
            <div class="info-row"><span class="info-label">èµ›åˆ¶:</span><span class="info-content">${c.format||''}</span></div>
            <div class="info-row"><span class="info-label">æ—¶é—´:</span><span class="info-content">${c.time||''}</span></div>
            <div class="info-row"><span class="info-label">ä¸»åŠæ–¹:</span><span class="info-content">${c.organizer||''}</span></div>
            <div class="info-row"><span class="info-label">ç½‘å€:</span><span class="info-content">${c.website?`<a href="${c.website}" target="_blank" class="website-link">è®¿é—®é“¾æ¥</a>`:''}</span></div>
            <div class="info-row"><span class="info-label">æ ‡ç­¾:</span><span class="info-content">${(c.tags||[]).join(', ')}</span></div>
          </div>
          <div class="card-actions">
            <button class="btn btn-primary btn-small" onclick="editCompetition('${c.id}')">âœï¸ ç¼–è¾‘</button>
            <button class="btn btn-danger btn-small" onclick="deleteCompetition('${c.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    /* ====== UI é€»è¾‘ï¼šæ–°å¢/ç¼–è¾‘/åˆ é™¤ ====== */
    function openAddModal(){
      currentEditingKey = null;
      currentTags = [];
      document.getElementById('modal-title').textContent = 'æ·»åŠ æ–°æ¯”èµ›';
      document.getElementById('competition-form').reset();
      renderTags();
      document.getElementById('competitionModal').style.display = 'block';
    }
    function editCompetition(id){
      const c = competitions.find(x => x.id === id);
      if(!c) return;
      currentEditingKey = id;
      currentTags = [...(c.tags||[])];
      document.getElementById('modal-title').textContent = 'ç¼–è¾‘æ¯”èµ›';
      document.getElementById('title').value = c.title || '';
      document.getElementById('fullName').value = c.fullName || '';
      document.getElementById('format').value = c.format || 'è‹±å›½è®®ä¼šåˆ¶è¾©è®ºï¼ˆBPï¼‰';
      document.getElementById('participants').value = c.participants || '';
      document.getElementById('time').value = c.time || '';
      document.getElementById('requirements').value = c.requirements || '';
      document.getElementById('location').value = c.location || '';
      document.getElementById('organizer').value = c.organizer || '';
      document.getElementById('website').value = c.website || '';
      renderTags();
      document.getElementById('competitionModal').style.display = 'block';
    }
    async function deleteCompetition(id){
      if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¯”èµ›å—ï¼Ÿ')) return;
      try{
        await callAPI('delete', id);
        showAlert('åˆ é™¤æˆåŠŸ');
        await loadCompetitions();
      }catch(e){
        showAlert('åˆ é™¤å¤±è´¥ï¼š' + e.message, 'error');
      }
    }

    function closeModal(){
      document.getElementById('competitionModal').style.display = 'none';
    }

    function showLoading(show){
      document.getElementById('loading').style.display = show ? 'block':'none';
      document.getElementById('competitions-grid').style.display = show ? 'none':'grid';
    }
    function showAlert(msg, type='success'){
      const box = document.getElementById('alert-container');
      const el = document.createElement('div');
      el.className = 'alert ' + (type==='success' ? 'alert-success':'alert-error');
      el.textContent = msg;
      box.appendChild(el);
      setTimeout(()=>{ box.removeChild(el); }, 4000);
    }

    /* ====== æ ‡ç­¾è¾“å…¥ ====== */
    function focusTagInput(){ document.getElementById('tag-input').focus(); }
    function renderTags(){
      const container = document.getElementById('tags-input');
      const input = document.getElementById('tag-input');
      container.querySelectorAll('.tag-item').forEach(t=>t.remove());
      currentTags.forEach((t,i)=>{
        const div = document.createElement('div');
        div.className='tag-item';
        div.innerHTML = `${t}<span class="tag-remove" onclick="removeTag(${i})">Ã—</span>`;
        container.insertBefore(div, input);
      });
    }
    function removeTag(i){ currentTags.splice(i,1); renderTags(); }

    /* ====== ä¿å­˜ï¼ˆæ–°å¢/æ›´æ–°ï¼‰ ====== */
    async function saveCompetition(){
      const form = document.getElementById('competition-form');
      if(!form.checkValidity()){ form.reportValidity(); return; }

      const recUI = {
        title:        document.getElementById('title').value.trim(),
        fullName:     document.getElementById('fullName').value.trim(),
        format:       document.getElementById('format').value.trim(),
        participants: document.getElementById('participants').value.trim(),
        time:         document.getElementById('time').value.trim(),
        requirements: document.getElementById('requirements').value.trim(),
        location:     document.getElementById('location').value.trim(),
        organizer:    document.getElementById('organizer').value.trim(),
        website:      document.getElementById('website').value.trim(),
        tags:         currentTags.slice()
      };

      const recSheet = {
        short_name: recUI.title,
        full_name:  recUI.fullName,
        format:     recUI.format,
        audience:   recUI.participants,
        time:       recUI.time,
        requirement:recUI.requirements,
        location:   recUI.location,
        organizer:  recUI.organizer,
        url:        recUI.website,
        tags:       (recUI.tags||[]).join('|')
      };

      const action = currentEditingKey ? 'update' : 'add';
      try{
        await callAPI(action, recSheet);
        showAlert(currentEditingKey ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
        closeModal();
        await loadCompetitions();
      }catch(e){
        showAlert('ä¿å­˜å¤±è´¥ï¼š' + e.message, 'error');
      }
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    window.onclick = function(e){
      const m = document.getElementById('competitionModal');
      if(e.target===m) closeModal();
    }
  </script>
</body>
</html>
